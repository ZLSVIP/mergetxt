<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多类型文件合并工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.544.0/dist/umd/lucide.min.js"></script>

    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #64748b;
            --accent-color: #06b6d4;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
            --drag-over-item: rgba(59, 130, 246, 0.2);
        }
        .dark {
            --primary-color: #60a5fa;
            --secondary-color: #94a3b8;
            --accent-color: #22d3ee;
            --background-color: #0f172a;
            --card-background: #1e293b;
            --text-color: #f1f5f9;
            --border-color: #334155;
            --drag-over-item: rgba(59, 130, 246, 0.3);
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--card-background);
            border-color: var(--border-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-secondary:hover {
            opacity: 0.9;
        }
        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }
        .btn-accent:hover {
            opacity: 0.9;
        }
        .file-item {
            border-color: var(--border-color);
            transition: all 0.2s;
        }
        .file-item:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        .dark .file-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
        .preview-container {
            background-color: var(--card-background);
            border-color: var(--border-color);
            /* 控制预览窗口最大高度，超出滚动 */
            max-height: 400px;
            height: 300px;
        }
        .drag-over {
            border-color: var(--primary-color);
            background-color: rgba(59, 130, 246, 0.1);
        }
        .dark .drag-over {
            background-color: rgba(59, 130, 246, 0.2);
        }
        .separator-input, .title-input {
            background-color: var(--card-background);
            border-color: var(--border-color);
            color: var(--text-color);
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: #22c55e;
            color: white;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .toast.show {
            opacity: 1;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        /* 历史记录样式 */
        .history-item {
            border-color: var(--border-color);
            cursor: pointer;
        }
        .history-item:hover {
            background-color: rgba(59, 130, 246, 0.05);
        }
        .dark .history-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="font-sans">
    <div class="min-h-screen flex flex-col">
        <header class="p-4 card shadow-sm flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i data-lucide="file-text" class="text-primary-color"></i>
                <h1 class="text-2xl font-bold">多类型文件合并工具</h1>
            </div>
            <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700">
                <i data-lucide="sun" class="text-primary-color block dark:hidden"></i>
                <i data-lucide="moon" class="text-primary-color hidden dark:block"></i>
            </button>
        </header>

        <main class="flex-grow p-4 md:p-6 lg:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- 左侧边栏：文件上传和操作 -->
                <div class="lg:col-span-1">
                    <div class="card p-4 rounded-lg shadow-md h-full flex flex-col">
                        <h2 class="text-lg font-semibold mb-3 flex items-center">
                            <i data-lucide="upload" class="mr-2 text-primary-color"></i>
                            文件上传
                        </h2>
                        
                        <div id="drop-area" class="border-2 border-dashed rounded-lg p-4 text-center cursor-pointer mb-4 flex flex-col items-center justify-center h-28">
                            <i data-lucide="file-plus-2" class="w-12 h-12 text-secondary-color mb-2"></i>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">拖拽文件到此处，或点击上传</p>
                            <p class="text-xs text-gray-500 dark:text-gray-500">支持 TXT、CSV、JSON、MD 格式</p>
                            <input type="file" id="file-input" class="hidden" accept=".md,.txt,.csv,.json" multiple>
                        </div>

                        <div class="mb-4">
                            <h3 class="text-md font-medium mb-2 flex items-center">
                                <i data-lucide="list-ordered" class="mr-2 text-primary-color"></i>
                                文件列表
                                <span id="file-count" class="ml-2 text-xs bg-primary-color text-white px-2 py-0.5 rounded-full">0</span>
                            </h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">拖拽调整文件合并顺序</p>
                            <div id="file-list" class="max-h-48 overflow-y-auto space-y-2">
                                <!-- 文件列表将在这里动态生成 -->
                            </div>
                        </div>

                        <div class="space-y-3 mb-4">
                            <div>
                                <label for="title-input" class="block text-xs font-medium mb-1">合并后标题:</label>
                                <input type="text" id="title-input" class="title-input w-full p-2 border rounded-md text-sm" placeholder="输入标题（可选）">
                            </div>
                            <div>
                                <label for="separator-input" class="block text-xs font-medium mb-1">文件分隔符:</label>
                                <input type="text" id="separator-input" class="separator-input w-full p-2 border rounded-md text-sm" value="---" placeholder="输入分隔符（可选）">
                            </div>
                        </div>

                        <div class="mt-auto flex space-x-2">
                            <button id="merge-btn" class="btn-primary flex-1 py-2 px-4 rounded-md font-medium flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                                <i data-lucide="merge" class="mr-1 w-4 h-4"></i>
                                合并文件
                            </button>
                            <button id="clear-btn" class="btn-secondary py-2 px-4 rounded-md font-medium flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed text-sm" disabled>
                                <i data-lucide="trash-2" class="mr-1 w-4 h-4"></i>
                                清空
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 右侧主内容区：预览和历史记录 -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- 合并预览区域 -->
                    <div class="card p-4 rounded-lg shadow-md">
                        <h2 class="text-lg font-semibold mb-3 flex items-center">
                            <i data-lucide="eye" class="mr-2 text-primary-color"></i>
                            合并预览
                        </h2>
                        <div id="preview-container" class="preview-container w-full p-3 border rounded-md overflow-y-auto">
                            <div id="preview-placeholder" class="flex flex-col items-center justify-center h-full text-gray-500 dark:text-gray-400">
                                <i data-lucide="file-text" class="w-12 h-12 mb-3"></i>
                                <p class="text-sm">上传文件并点击"合并文件"以预览结果</p>
                            </div>
                            <pre id="preview-content" class="w-full whitespace-pre-wrap hidden text-sm"></pre>
                        </div>
                        <div id="download-section" class="mt-4 hidden">
                            <button id="download-btn" class="btn-accent w-full py-2 px-4 rounded-md font-medium flex items-center justify-center text-sm">
                                <i data-lucide="download" class="mr-2 w-4 h-4"></i>
                                下载合并文件
                            </button>
                        </div>
                    </div>

                    <!-- 历史记录区域 -->
                    <div class="card p-4 rounded-lg shadow-md">
                        <h2 class="text-lg font-semibold mb-3 flex items-center justify-between">
                            <span class="flex items-center">
                                <i data-lucide="clock" class="mr-2 text-primary-color"></i>
                                历史记录
                            </span>
                            <button id="clear-history-btn" class="text-xs text-gray-500 dark:text-gray-400 hover:text-primary-color">
                                清空历史
                            </button>
                        </h2>
                        <div id="history-list" class="max-h-40 overflow-y-auto space-y-2">
                            <!-- 历史记录将在这里动态生成 -->
                            <div id="history-placeholder" class="flex flex-col items-center justify-center h-32 text-gray-500 dark:text-gray-400">
                                <i data-lucide="history" class="w-10 h-10 mb-2"></i>
                                <p class="text-xs">暂无合并历史</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="p-4 text-center text-sm text-gray-600 dark:text-gray-400 card mt-auto">
            <p>© 2025 多类型文件合并工具 | 支持MD/TXT/CSV/JSON合并</p>
        </footer>
    </div>

    <!-- Toast 提示 -->
    <div id="toast" class="toast"></div>

    <script>
        lucide.createIcons();


        // 主题切换
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;
        
        // 检查本地存储中的主题偏好
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            html.classList.add('dark');
        } else {
            html.classList.remove('dark');
        }

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
            lucide.createIcons(); // 重新渲染图标以适应新主题
        });

        // 文件上传和处理
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const fileCount = document.getElementById('file-count');
        const mergeBtn = document.getElementById('merge-btn');
        const clearBtn = document.getElementById('clear-btn');
        const titleInput = document.getElementById('title-input');
        const separatorInput = document.getElementById('separator-input');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const previewContent = document.getElementById('preview-content');
        const downloadSection = document.getElementById('download-section');
        const downloadBtn = document.getElementById('download-btn');
        const toast = document.getElementById('toast');

        let uploadedFiles = [];
        let mergedContent = '';
        let mergedType = 'md'; // 合并类型
        let draggingIndex = -1; // 拖拽中的文件索引

        // 显示 toast 提示
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = `toast ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // 读取不同类型文件的内容
        async function readFileContent(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            const content = await readTextFile(file);
            
            // 对JSON文件进行特殊处理，格式化显示
            if (ext === 'json') {
                try {
                    const parsedJson = JSON.parse(content);
                    return JSON.stringify(parsedJson, null, 2);
                } catch (e) {
                    // 如果JSON解析失败，返回原始内容并添加警告
                    return `⚠️ JSON格式可能不正确：\n${content}`;
                }
            }
            
            return content;
        }

        // 读取文本文件
        function readTextFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsText(file);
            });
        }



        // 处理文件上传
        function handleFiles(files) {
            const validFiles = Array.from(files).filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return ['md', 'txt', 'csv', 'json'].includes(ext);
            });
            
            if (validFiles.length === 0) {
                showToast('请选择支持的文件类型：md/txt/csv/json', 'error');
                return;
            }

            uploadedFiles = [...uploadedFiles, ...validFiles];
            updateFileList();
            updateButtonStates();
            showToast(`成功上传 ${validFiles.length} 个文件`);
        }

        // 更新文件列表显示
        function updateFileList() {
            fileList.innerHTML = '';
            fileCount.textContent = uploadedFiles.length;

            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item p-3 border rounded-md flex items-center justify-between fade-in';
                fileItem.draggable = true;
                fileItem.dataset.index = index;

                fileItem.innerHTML = `
                    <div class="flex items-center">
                        <i data-lucide="file-md" class="mr-2 text-primary-color"></i>
                        <span class="text-sm truncate max-w-[150px]">${file.name}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="preview-file-btn p-1 hover:bg-gray-200 dark:hover:bg-slate-700 rounded" data-index="${index}">
                            <i data-lucide="eye" class="w-4 h-4 text-secondary-color"></i>
                        </button>
                        <button class="remove-file-btn p-1 hover:bg-gray-200 dark:hover:bg-slate-700 rounded" data-index="${index}">
                            <i data-lucide="x" class="w-4 h-4 text-red-500"></i>
                        </button>
                    </div>
                `;

                fileList.appendChild(fileItem);
            });

            lucide.createIcons();

            // 添加事件监听器
            document.querySelectorAll('.remove-file-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.dataset.index);
                    uploadedFiles.splice(index, 1);
                    updateFileList();
                    updateButtonStates();
                    showToast('文件已移除');
                });
            });

            document.querySelectorAll('.preview-file-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(btn.dataset.index);
                    previewSingleFile(index);
                });
            });

            // 添加拖拽排序事件监听器
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggingIndex = parseInt(item.dataset.index);
                    item.classList.add('opacity-50');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', (e) => {
                    item.classList.remove('opacity-50', 'drag-over');
                    draggingIndex = -1;
                    // 清除所有拖拽相关的样式
                    document.querySelectorAll('.file-item').forEach(fi => {
                        fi.classList.remove('drag-over');
                    });
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                item.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    if (draggingIndex !== -1 && parseInt(item.dataset.index) !== draggingIndex) {
                        item.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const dropIndex = parseInt(item.dataset.index);
                    
                    if (draggingIndex !== -1 && draggingIndex !== dropIndex) {
                        // 重新排序文件数组
                        const draggedFile = uploadedFiles[draggingIndex];
                        uploadedFiles.splice(draggingIndex, 1);
                        uploadedFiles.splice(dropIndex, 0, draggedFile);
                        
                        // 更新UI
                        updateFileList();
                        showToast('文件顺序已调整');
                    }
                    
                    item.classList.remove('drag-over');
                });
            });
        }

        // 预览单个文件已集成到updateFileList中的事件监听器

        // 合并文件
        async function mergeFiles() {
            if (uploadedFiles.length === 0) return;

            const title = titleInput.value.trim();
            const separator = separatorInput.value.trim();
            let content = '';

            // 添加标题（如果有）
            if (title) {
                content += `# ${title}\n\n`;
            }

            // 遍历文件合并内容
            for (let i = 0; i < uploadedFiles.length; i++) {
                const file = uploadedFiles[i];
                // 添加文件名作为子标题
                content += `## ${file.name}\n\n`;
                // 读取文件内容
                const fileContent = await readFileContent(file);
                content += fileContent;
                
                // 添加分隔符（如果不是最后一个文件且分隔符不为空）
                if (i < uploadedFiles.length - 1) {
                    content += separator ? `\n\n${separator}\n\n` : '\n\n';
                }
            }

            mergedContent = content;
            
            // 更新预览
            previewPlaceholder.classList.add('hidden');
            previewContent.classList.remove('hidden');
            previewContent.textContent = content;
            previewContent.style.whiteSpace = 'pre-wrap';
            previewContent.style.fontFamily = 'monospace';
            
            downloadSection.classList.remove('hidden');
            showToast('文件合并成功！');

            // 记录历史
            addToHistory({
                title: title || '合并文件',
                count: uploadedFiles.length,
                time: new Date().toLocaleString(),
                files: uploadedFiles.map(f => f.name)
            });
        }

        // 下载合并文件
        function downloadMergedFile() {
            const title = titleInput.value.trim() || 'merged-files';
            const safeTitle = title.replace(/\s+/g, '-').toLowerCase();
            const filename = `${safeTitle}.md`;
            const mimeType = 'text/markdown';
            
            const blob = new Blob([mergedContent], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('文件下载已开始');
        }

        // 清空所有文件
        function clearFiles() {
            uploadedFiles = [];
            updateFileList();
            updateButtonStates();
            previewPlaceholder.classList.remove('hidden');
            previewContent.classList.add('hidden');
            downloadSection.classList.add('hidden');
            showToast('文件列表已清空');
        }

        // ========== 历史记录管理 ==========
        // 添加历史记录
        function addToHistory(record) {
            let history = JSON.parse(localStorage.getItem('mergeHistory') || '[]');
            history.unshift(record); // 新增记录放在最前面
            history = history.slice(0, 10); // 最多保留10条
            localStorage.setItem('mergeHistory', JSON.stringify(history));
            renderHistory();
        }

        // 渲染历史记录
        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('mergeHistory') || '[]');
            if (history.length === 0) {
                historyPlaceholder.classList.remove('hidden');
                historyList.innerHTML = '';
                return;
            }

            historyPlaceholder.classList.add('hidden');
            historyList.innerHTML = '';
            history.forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item p-3 border rounded-md fade-in';
                historyItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-medium text-sm">${item.title}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                ${item.count}个文件 · ${item.time}
                            </p>
                        </div>
                        <i data-lucide="clock" class="w-4 h-4 text-secondary-color"></i>
                    </div>
                    <p class="text-xs text-gray-600 dark:text-gray-500 mt-2 line-clamp-2">
                        文件：${item.files.join(', ')}
                    </p>
                `;
                historyList.appendChild(historyItem);
            });

            lucide.createIcons();
        }

        // 清空历史记录
        function clearHistory() {
            localStorage.removeItem('mergeHistory');
            renderHistory();
            showToast('历史记录已清空');
        }

        // 更新按钮状态
        function updateButtonStates() {
            mergeBtn.disabled = uploadedFiles.length === 0;
            clearBtn.disabled = uploadedFiles.length === 0;
        }

        // 拖拽上传功能
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('drag-over');
        }

        function unhighlight() {
            dropArea.classList.remove('drag-over');
        }

        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        // 点击上传
        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            handleFiles(fileInput.files);
        });

        // 按钮事件监听
        mergeBtn.addEventListener('click', mergeFiles);
        clearBtn.addEventListener('click', clearFiles);
        downloadBtn.addEventListener('click', downloadMergedFile);

        // 历史记录事件监听
        const historyList = document.getElementById('history-list');
        const historyPlaceholder = document.getElementById('history-placeholder');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        clearHistoryBtn.addEventListener('click', clearHistory);

        // 初始化
        updateButtonStates();
        renderHistory(); // 页面加载时渲染历史记录
    </script>
</body>
</html>